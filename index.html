<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="不积跬步，无以至千里">
<meta property="og:type" content="website">
<meta property="og:title" content="Ronny&#39;s Notebook">
<meta property="og:url" content="https://ronnywang99.github.io/index.html">
<meta property="og:site_name" content="Ronny&#39;s Notebook">
<meta property="og:description" content="不积跬步，无以至千里">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ronny&#39;s Notebook">
<meta name="twitter:description" content="不积跬步，无以至千里">






  <link rel="canonical" href="https://ronnywang99.github.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Ronny's Notebook</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ronny's Notebook</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ronnywang99.github.io/2019/02/14/GKE-ESP-project-summary/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhe Wang">
      <meta itemprop="description" content="不积跬步，无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ronny's Notebook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/14/GKE-ESP-project-summary/" class="post-title-link" itemprop="url">GKE-ESP-project-summary</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-14 09:41:37 / Modified: 15:58:34" itemprop="dateCreated datePublished" datetime="2019-02-14T09:41:37-05:00">2019-02-14</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Project-Notes/" itemprop="url" rel="index"><span itemprop="name">Project Notes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Background"><a href="#Background" class="headerlink" title="Background:"></a>Background:</h2><p>Our application service has one endpoint which is used to serve as a side checking of our system business status beyond the response to the normal requests. This endpoint is mainly used inside the team and other stakeholder projects. While during one time we debugged with our clients on their issues, we “borrowed” this endpoint to them in order to gather more information. </p>
<p>It helped us to identify where the potential problem is and inspired us with solutions. At the same time, we considered to have this endpoint protected without exposing to outside world, as well as to keep the capability to grant access to clients temporally.</p>
<p>We brought up the method to add <code>apiKey</code> in request headers to protect the endpoint. When a client needs to hit this endpoint, we will generate a temporary one thru <code>GCP -&gt; APIs &amp; Services -&gt; Credentials</code> panel. After its usage, we will revoke it.</p>
<h2 id="Steps-of-ESP-setup"><a href="#Steps-of-ESP-setup" class="headerlink" title="Steps of ESP setup:"></a>Steps of ESP setup:</h2><h3 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites:"></a>Prerequisites:</h3><p>Enable Cloud Endpoints API for your project in the Google Cloud Endpoints page in the API Manager</p>
<h3 id="1-Configuring-Endpoints"><a href="#1-Configuring-Endpoints" class="headerlink" title="1. Configuring Endpoints:"></a>1. Configuring Endpoints:</h3><p>Setup the OpenAPI configuration file (it can have its own name, <a href="https://github.com/GoogleCloudPlatform/endpoints-samples/blob/master/k8s/openapi.yaml" target="_blank" rel="noopener">the openapi.yaml</a> ) to configure the endpoint, like below: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">swagger:</span> <span class="string">"2.0"</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line"><span class="attr">  description:</span> <span class="string">"A simple Google Cloud Endpoints API example."</span></span><br><span class="line"><span class="attr">  title:</span> <span class="string">"Endpoints Example"</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">"1.0.0"</span></span><br><span class="line"><span class="attr">host:</span> <span class="attr">host:</span> <span class="string">"echo-api.endpoints.YOUR-PROJECT-ID.cloud.goog"</span></span><br><span class="line"><span class="attr">schemes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">https</span></span><br><span class="line"><span class="attr">produces:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">application/json</span></span><br></pre></td></tr></table></figure>
<h3 id="2-Setup-securityDefinitions"><a href="#2-Setup-securityDefinitions" class="headerlink" title="2. Setup securityDefinitions:"></a>2. Setup securityDefinitions:</h3><p>In above .yaml file, add the <code>securityDefinitions</code> sections to restrict the access, as well as enable the <code>CORS</code> option like below: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">"/the-endpoint-you-work-on"</span><span class="string">:</span></span><br><span class="line"><span class="attr">    get:</span></span><br><span class="line"><span class="attr">      operationId:</span> <span class="string">"id-of-the-endpoint-you-work-on"</span></span><br><span class="line"><span class="attr">      responses:</span></span><br><span class="line">        <span class="number">200</span><span class="string">:</span></span><br><span class="line"><span class="attr">          description:</span> <span class="string">"desc-of-the-endpoint-you-work-on"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="comment"># Restricts access to all paths with API keys</span></span><br><span class="line"><span class="attr">  - api_key:</span> <span class="string">[]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">securityDefinitions:</span></span><br><span class="line">  <span class="comment"># Configures basic authentication with API keys.</span></span><br><span class="line"><span class="attr">  api_key:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">"apiKey"</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"key"</span></span><br><span class="line"><span class="attr">    in:</span> <span class="string">"query"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">x-google-endpoints:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">echo-api.endpoints.YOUR-PROJECT-ID.cloud.goog</span></span><br><span class="line"><span class="attr">    allow_cors:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">```</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment">### 3. Deploying the sample API config to Google Service Management</span></span><br><span class="line"></span><br><span class="line"><span class="string">To</span> <span class="string">deploy</span> <span class="string">the</span> <span class="string">sample</span> <span class="string">application,</span> <span class="string">invoke</span> <span class="string">the</span> <span class="string">following</span> <span class="attr">command:</span></span><br></pre></td></tr></table></figure>
<p>gcloud endpoints services deploy &lt;your_esp&gt;.yaml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The command returns several lines of information, including a line similar to the following:</span><br></pre></td></tr></table></figure></p>
<p>Service Configuration [2018-02-14-r0] uploaded for service [echo-api.endpoints.example-project.cloud.goog]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">(The configuration ID that is displayed will change when you deploy a new version of the API.)</span><br><span class="line"> </span><br><span class="line">### 4. Setup ESP .kube.yml: </span><br><span class="line"></span><br><span class="line">```yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &lt;name&gt;</span><br><span class="line"></span><br><span class="line">spec:</span><br><span class="line">  replicas: &lt;numberOfReplicasNeeded&gt;</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: </span><br><span class="line">      maxUnavailable: </span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123;.app&#125;&#125;</span><br><span class="line">      env: &#123;&#123;.env&#125;&#125;</span><br><span class="line"></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: &#123;&#123;.app&#125;&#125;</span><br><span class="line">        env: &#123;&#123;.env&#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: &lt;container_name&gt;</span><br><span class="line">          image: gcr.io/endpoints-release/endpoints-runtime:1</span><br><span class="line">          args: [</span><br><span class="line">            &quot;-p&quot;, &quot;&lt;the port ESP listens on&gt;&quot;,</span><br><span class="line">            &quot;-a&quot;, &quot;&lt;the backend address&gt;&quot;,</span><br><span class="line">            &quot;-s&quot;, &quot;&lt;SERVICE_NAME&gt;&quot;,</span><br><span class="line">            &quot;-R&quot;, &quot;managed&quot;,   #rollout_strategy</span><br><span class="line">            &quot;-k&quot;, &quot;/etc/nginx/creds/service-account-creds.json&quot;,  # not needed for GKE</span><br><span class="line">          ]</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: &lt;the port ESP listens on&gt;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">If container native load balancer is used, include ingress service setup in the ESP .kube.yml file.</span><br><span class="line"></span><br><span class="line">### 5. Deploying to the cluster:</span><br><span class="line"></span><br><span class="line">Using kubectl create command to start the service.</span><br></pre></td></tr></table></figure></p>
<p>kubectl create -f esp_kube.yaml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">My project is using Drone for the CI/CD pipeline, so it can be involved in the .drone.yml for the service deployment. </span><br><span class="line"></span><br><span class="line">Example like below (the values come from your project configurations): </span><br><span class="line">```yaml</span><br><span class="line">  deploy-gke-dev-esp:</span><br><span class="line">    image: &lt;drone_gke.image&gt;</span><br><span class="line">    zone: &lt;zone&gt;</span><br><span class="line">    cluster: &lt;cluster_name&gt;</span><br><span class="line">    template: &lt;the_esp_kube.yml&gt;</span><br><span class="line">    secret_template: &quot;&quot;</span><br><span class="line">    vars:</span><br><span class="line">      app: </span><br><span class="line">      env: </span><br><span class="line">      meter_service_host: </span><br><span class="line">      app_port: </span><br><span class="line">      ce_esp_port: </span><br><span class="line">      service_port: </span><br><span class="line">      ce_service_name: &lt;the port ESP listens on&gt;</span><br><span class="line">      ce_service_version: </span><br><span class="line">      request_cpu: </span><br><span class="line">      limit_cpu: </span><br><span class="line">      request_memory: </span><br><span class="line">      limit_memory: </span><br><span class="line">    secrets:</span><br><span class="line">      - source: </span><br><span class="line">        target: </span><br><span class="line">    when:</span><br><span class="line">      branch: </span><br><span class="line">      event:</span><br></pre></td></tr></table></figure></p>
<h3 id="6-Verification"><a href="#6-Verification" class="headerlink" title="6. Verification:"></a>6. Verification:</h3><p>Give a try on the endpoint with/without the api key, or with an invalid api key to check whether the access restriction is setup or not.</p>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions:"></a>Conclusions:</h2><p>Identify the user scenarios for your services and setup the proper corresponding security definitions are necessary and important, given the security considerations.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ol>
<li><a href="https://github.com/GoogleCloudPlatform/endpoints-samples/tree/master/k8s" target="_blank" rel="noopener">GCP Endpoints samples</a></li>
<li><a href="https://cloud.google.com/endpoints/docs/openapi/get-started-kubernetes-engine" target="_blank" rel="noopener">GKE ESP Document</a>  </li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ronnywang99.github.io/2019/02/14/CORS-reseach-following/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhe Wang">
      <meta itemprop="description" content="不积跬步，无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ronny's Notebook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/14/CORS-reseach-following/" class="post-title-link" itemprop="url">CORS-reseach-following</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-14 09:22:33 / Modified: 11:33:46" itemprop="dateCreated datePublished" datetime="2019-02-14T09:22:33-05:00">2019-02-14</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Project-Notes/" itemprop="url" rel="index"><span itemprop="name">Project Notes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Things-that-covered-in-this-post"><a href="#Things-that-covered-in-this-post" class="headerlink" title="Things that covered in this post:"></a>Things that covered in this post:</h2><ol>
<li>GKE Configuring ESP to allow CORS requests;</li>
<li>CORS wildcard support in different browser.</li>
</ol>
<h2 id="Details"><a href="#Details" class="headerlink" title="Details:"></a>Details:</h2><h3 id="1-allowCors-in-x-google-endpoints"><a href="#1-allowCors-in-x-google-endpoints" class="headerlink" title="1. allowCors in x-google-endpoints:"></a>1. allowCors in x-google-endpoints:</h3><h4 id="What-Why"><a href="#What-Why" class="headerlink" title="What/Why:"></a>What/Why:</h4><p>CORS (Cross-origin resource sharing) is a standard mechanism that allows XMLHttpRequest (XHR) calls executed in a web page to interact with resources from different origins. Without CORS, the <code>same-origin policy</code> that is enforced by all browsers will prevent cross-origin requests.</p>
<p>For GKE project, you can start from the <a href="https://cloud.google.com/endpoints/docs/openapi/specify-proxy-startup-options" target="_blank" rel="noopener">ESP Startup Options</a>, or following the <a href="https://cloud.google.com/endpoints/docs/openapi/openapi-extensions#configuring_dns_on_the_cloudgoog_domain" target="_blank" rel="noopener">Google OpenAPI extentions</a> to setup. </p>
<h4 id="How"><a href="#How" class="headerlink" title="How:"></a>How:</h4><p>We were using the latter one to setup and to enable ESP to allow CORS request, so to implement our customized CORS support in our backend codes, we set <code>allowCors: true</code> so that ESP passes all CORS request through to backend. </p>
<p>Like below: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x-google-endpoints:</span><br><span class="line">- name: &quot;API_NAME.endpoints.PROJECT_ID.cloud.goog&quot;</span><br><span class="line">  allowCors: True</span><br></pre></td></tr></table></figure>
<p>After that deploy to make it working. </p>
<h3 id="2-CORS-wildcard-is-supported-differently-in-different-browsers"><a href="#2-CORS-wildcard-is-supported-differently-in-different-browsers" class="headerlink" title="2. CORS wildcard * is supported differently in different browsers:"></a>2. CORS wildcard * is supported differently in different browsers:</h3><h4 id="What"><a href="#What" class="headerlink" title="What:"></a>What:</h4><p>We had below configurations in <code>Access-Control-Allow-Headers</code> in our codes: </p>
<pre><code>corsRequests.Header().Set(&quot;Access-Control-Allow-Headers&quot;, &quot;DNT, X-CustomHeader, &quot; +
    &quot;Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Cookie, Accept, *&quot;)
</code></pre><p>Please note the wildcard <code>*</code> at the last place. </p>
<p>Recently we had a new header needs to be supported in the CORS request headers, let’s call it <code>x-new-header</code>. This field was not explicitly added in above headers list as we assume the wildcard <code>*</code> could cover it. </p>
<p>After the setup in consumer web app, it works well in Chrome browser during smoke checking. While we found it not supported well in Firefox and Safari browsers, which are shown as below: </p>
<p>Error shows in Firefox console:<br><img src="/images/CORS-reseach-following-firefox.png" alt="firefox"><br>Error shows in Safari console:<br><img src="/images/CORS-reseach-following-safari.png" alt="safari"></p>
<h4 id="Why"><a href="#Why" class="headerlink" title="Why:"></a>Why:</h4><p>In Mozilla developer doc, we found below info: </p>
<blockquote>
<p>When responding to a credentialed request, the server must specify an origin in the value of the Access-Control-Allow-Origin header, instead of specifying the “*” wildcard.</p>
</blockquote>
<h4 id="How-1"><a href="#How-1" class="headerlink" title="How:"></a>How:</h4><p>It works after the <code>x-new-header</code> was explicitly added in the <code>Access-Control-Allow-Headers</code> settings.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener">Same-origin policy</a></li>
<li><a href="https://cloud.google.com/endpoints/docs/openapi/specify-proxy-startup-options" target="_blank" rel="noopener">GCP ESP Startup Options</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">Mozilla CORS Developer Doc</a></li>
<li><a href="https://cloud.google.com/endpoints/docs/openapi/how-to" target="_blank" rel="noopener">How-to Guides for deploying API on GCP</a></li>
<li><a href="https://cloud.google.com/endpoints/docs/openapi/openapi-extensions#configuring_to_allow_cors_requests" target="_blank" rel="noopener">GCP Configure ESP to allow CORS</a></li>
<li>StackOverflow: </li>
</ol>
<ul>
<li><a href="https://stackoverflow.com/questions/13146892/cors-access-control-allow-headers-wildcard-being-ignored" target="_blank" rel="noopener">Cors Access-Control-Allow-Headers wildcard being ignored?</a></li>
<li><a href="https://stackoverflow.com/questions/19743396/cors-cannot-use-wildcard-in-access-control-allow-origin-when-credentials-flag-i" target="_blank" rel="noopener">CORS: Cannot use wildcard in Access-Control-Allow-Origin when credentials flag is true</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ronnywang99.github.io/2019/01/28/CORS-preflight-check/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhe Wang">
      <meta itemprop="description" content="不积跬步，无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ronny's Notebook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/28/CORS-preflight-check/" class="post-title-link" itemprop="url">CORS preflight check</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-28 17:26:38" itemprop="dateCreated datePublished" datetime="2019-01-28T17:26:38-05:00">2019-01-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-08 15:04:32" itemprop="dateModified" datetime="2019-02-08T15:04:32-05:00">2019-02-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Project-Notes/" itemprop="url" rel="index"><span itemprop="name">Project Notes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Starting-Point"><a href="#Starting-Point" class="headerlink" title="Starting Point:"></a>Starting Point:</h2><p>When working on AMP and related Subscribe to Google (SwG) projects, we dealt with CORS a bit and encountered one concept called “CORS preflight check”. It is required in amp-subscriptions <strong><em>Pingback</em></strong> endpoint which set the JSON object as <code>Content-type: text/plain</code>. This is intentional as it removes the need for a CORS preflight check.</p>
<h2 id="CORS-Intro"><a href="#CORS-Intro" class="headerlink" title="CORS Intro:"></a>CORS Intro:</h2><p>CORS or Cross-Origin Resource Sharing is a way for server to check if requests coming in are allowed if they’re coming from a different origin. Meaning, if web application <code>xyz.com</code> makes a request to <code>abc.com</code>, using either <code>XMLHttpRequest</code> or <code>fetch</code> API, CORS will use HTTP headers to tell the application if <code>xyz.com</code> has the right permission to access <code>abc.com</code>. The permissions need to be configured at <code>abc.com</code>, where you specify what methods and from what origins can come through.</p>
<p>By default, for security, both <code>XMLHttpRequest</code> and <code>fetch</code> follow <code>same-origin</code> policy so if you haven’t specifically configured CORS and the HTTP headers on your back-end, the requests from different domain will fail.</p>
<h2 id="What-is-a-CORS-preflight-request"><a href="#What-is-a-CORS-preflight-request" class="headerlink" title="What is a CORS preflight request?"></a>What is a CORS preflight request?</h2><p>When it comes to preflight, we can divide requests into two categories: <em>simple requests</em> and <em>preflighted requests</em>.</p>
<h3 id="Simple-Requests"><a href="#Simple-Requests" class="headerlink" title="Simple Requests:"></a>Simple Requests:</h3><p>Some requests don’t trigger a preflight check. There is a simple exchange of CORS headers between client and server to check the permissions. For request to be simple, it needs to meet several criterias:</p>
<ul>
<li>The allowed methods are<ul>
<li>GET</li>
<li>POST</li>
<li>HEAD</li>
</ul>
</li>
<li>The only headers that are allowed: <ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Content-Type (but note the additional requirements below)</li>
<li>Last-Event-ID</li>
<li>DPR</li>
<li>Save-Data</li>
<li>Viewport-Width</li>
<li>Width</li>
</ul>
</li>
<li>There are only three values allowed for <code>Content-Type</code> header for simple requests:<ul>
<li>application/x-www-form-urlencoded</li>
<li>multipart/form-data</li>
<li>text/plain</li>
</ul>
</li>
<li>No event listeners are registered on any <code>XMLHttpRequestUpload</code> object used in the request; these are accessed using the <code>XMLHttpRequest.upload</code> property.</li>
<li>No <code>ReadableStream</code> object is used in the request.</li>
</ul>
<h3 id="Preflight-Requests"><a href="#Preflight-Requests" class="headerlink" title="Preflight Requests:"></a>Preflight Requests:</h3><p>Now, if the request doesn’t meet the criteria above, the browser automatically sends a HTTP request <em>before</em> the original one by <code>OPTIONS</code> method to check whether it is safe to send the original request. Most common cases happen if requests have <code>DELETE</code>, <code>PUT</code> or any other methods that can amend data, any headers that are not <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header" target="_blank" rel="noopener">CORS-safelisted</a> (listed above) or <code>Content-Type</code> of, let’s say <code>application/json</code>.</p>
<p>So, let’s say we send a <code>DELETE</code> request to the server. The browser sends <code>OPTIONS</code> request with headers containing info about the <code>DELETE</code> request we made.</p>
<figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS /users/:id </span><br><span class="line"><span class="attribute">Access-Control-Request-Method</span>: DELETE </span><br><span class="line"><span class="attribute">Access-Control-Request-Headers</span>: origin, x-requested-with</span><br><span class="line"><span class="attribute">Origin</span>: https://example.com</span><br></pre></td></tr></table></figure>
<p>The server then makes a check and if it allows the request, it responds with status code <code>200</code> OK.</p>
<figure class="highlight http"><figcaption><span>request</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Length</span>: 0</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: *</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>: POST, GET, OPTIONS, DELETE</span><br></pre></td></tr></table></figure>
<p>After this check, the browser will send the original <code>DELETE</code> request we made in the first place.</p>
<h3 id="Deal-with-it"><a href="#Deal-with-it" class="headerlink" title="Deal with it:"></a>Deal with it:</h3><p>The easiest option would be to to avoid the preflight request by making sure the request falls into the <code>simple</code> category. Go through your settings and headers and remove or change any complex headers that aren’t needed.</p>
<p>However, this doesn’t solve all cases. For example if the request is authenticated and sending <code>Authorization</code> header with tokens by <code>PUT</code> or <code>DELETE</code> methods, it can not just be simply put in above <code>simple</code> category. In this case, deal with <code>OPTIONS</code> handling following the document, like, using <a href="https://www.npmjs.com/package/cors#enabling-cors-pre-flight" target="_blank" rel="noopener">cors npm package</a> that enables CORS.</p>
<h2 id="More-with-my-references"><a href="#More-with-my-references" class="headerlink" title="More with my references:"></a>More with my references:</h2><ol>
<li>MDN’s articles on <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">CORS</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/OPTIONS" target="_blank" rel="noopener">OPTIONS</a></li>
<li><a href="https://damon.ghost.io/killing-cors-preflight-requests-on-a-react-spa/" target="_blank" rel="noopener">Good example that trying to eliminate preflight</a></li>
<li><a href="https://www.npmjs.com/package/cors#enabling-cors-pre-flight" target="_blank" rel="noopener">npm CORS</a></li>
<li><a href="https://github.com/ampproject/amphtml/blob/master/spec/amp-cors-requests.md" target="_blank" rel="noopener">CORS request in AMP</a></li>
<li><a href="https://github.com/ampproject/amphtml/blob/master/extensions/amp-subscriptions/amp-subscriptions.md" target="_blank" rel="noopener">AMP subscriptions</a>   </li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ronnywang99.github.io/2019/01/23/Deal-with-XFFs/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhe Wang">
      <meta itemprop="description" content="不积跬步，无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ronny's Notebook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/23/Deal-with-XFFs/" class="post-title-link" itemprop="url">Deal with XFFs</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-23 15:26:13" itemprop="dateCreated datePublished" datetime="2019-01-23T15:26:13-05:00">2019-01-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-08 15:04:32" itemprop="dateModified" datetime="2019-02-08T15:04:32-05:00">2019-02-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Project-Notes/" itemprop="url" rel="index"><span itemprop="name">Project Notes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Description"><a href="#Description" class="headerlink" title="Description:"></a>Description:</h2><p>Recently we faced few problems about recognizing user’s IP address and make the corresponding response properly. It impacts the user to get expected services from our application. It’s time consuming to debug because of not enough contexts from clients (here is the IP address information we need), and we had rounds of conversation with clients to grab it and have a better understanding.</p>
<h2 id="What’s-happening"><a href="#What’s-happening" class="headerlink" title="What’s happening:"></a>What’s happening:</h2><p>One part of our services needs to receive and recognizes user’s IP address information in order to provide the right services to users, if user’s IP is in scope of the IP range we configured. While in the network world, there are different types of IP address; what’s more, the IP address could be mis-configured or re-routed on the way from user to our server. </p>
<p>We had two user cases having similar issue due to IP address not recognized properly. The debugging methods for them are pretty similar but coming out with different solutions.</p>
<ul>
<li>The similarity is we figured out by checking what we get from user based on XFF (<em>X-FORWARDED-FOR</em> information);</li>
<li>The difference is one needs client’s IT team to check and configure their network settings, and another one needs our fix in the IP checking logic.</li>
</ul>
<p>I will take the latter one as example to explain. </p>
<h2 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging:"></a>Debugging:</h2><ol>
<li><p>Grab the IP address from each user case’s HTTP request and analyze what type the IP address is - internal private IP, ISP IP, CDN service provider IP, or a regular public IP.</p>
</li>
<li><p>For each HTTP request, grab it from logs and identify which IP address is passed to our service, and compare it against the IP from HTTP request header. </p>
</li>
<li><p>Based on the comparison, locate it in the code logic which handles the IP address processing, and find out the working part vs. missing part in the logic.</p>
</li>
<li><p>During the analysis, we observed the IPs in X-FORWARDED-FOR header are not processed properly. Normally, there are 3 IPs included in X-FORWARDED-FOR. But the existing logic only checks and fetches the first one while ignoring the other two, and it doesn’t help this user who reported the problem. The tricky thing is it doesn’t work only on this user, so we have to figure out a single route to solve the problem and make sure not impacting other users.</p>
</li>
<li><p>And we also observed the IP address processing logic misses one scenario that IP from Fastly.</p>
</li>
</ol>
<h2 id="How-to-fix"><a href="#How-to-fix" class="headerlink" title="How to fix:"></a>How to fix:</h2><ol>
<li><p>Add logic to process the IPs from Fastly if the web app served thru Fastly. It’s pain to add this one since in the future it could change on the infrastrue level again (like we used CloudFlare before and had similar fix).</p>
</li>
<li><p>Add logic to process the IPs from X-FORWARDED-FOR and setup a single route for this user. So only this user would get the single route to access.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private function extractHeaderIp($headerValue, $ipOrder)</span><br><span class="line">&#123;</span><br><span class="line">    $headerIps = explode(&apos;,&apos;, $headerValue);</span><br><span class="line">    if (isset($headerIps[$ipOrder])) &#123;</span><br><span class="line">        return trim($headerIps[$ipOrder]);</span><br><span class="line">    &#125;</span><br><span class="line">    return &apos;1.1.1.1&apos;;</span><br><span class="line">&#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    elseif ($ipSource === self::IP_SOURCE_XF1) &#123;</span><br><span class="line">        return $this-&gt;extractHeaderIp(filter_input(INPUT_SERVER, &apos;HTTP_X_FORWARDED_FOR&apos;), 0);</span><br><span class="line">    &#125; elseif ($ipSource === self::IP_SOURCE_XF2) &#123;</span><br><span class="line">        return $this-&gt;extractHeaderIp(filter_input(INPUT_SERVER, &apos;HTTP_X_FORWARDED_FOR&apos;), 1);</span><br><span class="line">    &#125; elseif ($ipSource === self::IP_SOURCE_XF3) &#123;</span><br><span class="line">        return $this-&gt;extractHeaderIp(filter_input(INPUT_SERVER, &apos;HTTP_X_FORWARDED_FOR&apos;), 2);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Some-takeaways"><a href="#Some-takeaways" class="headerlink" title="Some takeaways:"></a>Some takeaways:</h2><ol>
<li><p>Need to find another way to check the source instead of IP. Using IP to detect the source of user was a good way 20 years ago, while not nowadays, especially the internet world changed a lot. The explosive growth of internet brings the IP resources distribution problem. And so many proxies in middle of the source of user to the server side could misleading the IP recognition. Having token or key or other way for authorization could definitely help solving this kind of IP related legacy problems.  </p>
</li>
<li><p>How would it be if using IPv6? Still in thinking. </p>
</li>
<li><p><a href="https://stackoverflow.com/a/43014286/3799382" target="_blank" rel="noopener">About request.ip vs. request.remote_ip.</a></p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ronnywang99.github.io/2019/01/22/SED-command-on-MacOS/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhe Wang">
      <meta itemprop="description" content="不积跬步，无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ronny's Notebook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/22/SED-command-on-MacOS/" class="post-title-link" itemprop="url">sed command on MacOS</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-22 15:27:16" itemprop="dateCreated datePublished" datetime="2019-01-22T15:27:16-05:00">2019-01-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-08 15:04:32" itemprop="dateModified" datetime="2019-02-08T15:04:32-05:00">2019-02-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Project-Notes/" itemprop="url" rel="index"><span itemprop="name">Project Notes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Problem-Description"><a href="#Problem-Description" class="headerlink" title="Problem Description:"></a>Problem Description:</h2><p>When I worked on <em>sed</em> command on MacOS that modifying a file, I got below error in one try:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed: 1: &quot;./&lt;file_name&gt;&quot;: invalid command code .</span><br></pre></td></tr></table></figure></p>
<p>The command I used is:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;/&lt;!-- BlaBlaBla --&gt;/ r ./&lt;file1_name.xml&gt;&apos; ./&lt;file2_name.xml&gt;</span><br></pre></td></tr></table></figure></p>
<p>Here I have <em>-i</em> as an <em>sed</em> command option.</p>
<h2 id="Researches"><a href="#Researches" class="headerlink" title="Researches:"></a>Researches:</h2><p>The problem only occurred on my MacOS local environment, while this piece of command was copied from one line of codes, which actually works well on our Linux OS server.</p>
<p>Based on research and learning, I recognized that: </p>
<blockquote>
<p>“The behavior of shell utilities does differ in minor ways between unix variants. There are many unix variants, with a <a href="https://unix.stackexchange.com/questions/3196/evolution-of-operating-systems-from-unix/3202#3202" target="_blank" rel="noopener">complex history</a>. There are standardisation efforts such as the <a href="https://unix.stackexchange.com/questions/11983/what-exactly-is-posix" target="_blank" rel="noopener">POSIX</a> standard and its superset the <a href="https://www.wikiwand.com/en/Single_UNIX_Specification" target="_blank" rel="noopener">Single UNIX specification</a>. Most systems nowadays implement POSIX:2001, also known as the Single UNIX Specification version 3, with minor deviations and many extensions. The Single Unix specification is not a tutorial, but version 3 is readable if you already have an idea of what a command is doing. You can consult it to know if some feature is standard or an extension of a particular system.</p>
</blockquote>
<blockquote>
<p>A majority of unix users use Linux and haven’t used any other variant. Linux comes with <a href="https://www.wikiwand.com/en/GNU" target="_blank" rel="noopener">GNU</a> utilities, which often have many extensions to the standard. So you’ll find quite a lot of code out there that works on Linux but not on other unixes, because it relies on those extensions.</p>
</blockquote>
<blockquote>
<p>Regarding sed, consult the sed Single Unix specification for the minimum that every system is supposed to support, the man page on your system for what your implementation supports, and the <a href="http://www.gnu.org/software/sed/manual/sed.html" target="_blank" rel="noopener">GNU sed manual</a> for what most people out there use.”</p>
</blockquote>
<p>and</p>
<blockquote>
<p>“OS X currently comes with a FreeBSD sed from 2005. Most of the differences below also apply to other BSD sed versions.</p>
</blockquote>
<blockquote>
<p>OS X’s sed uses <code>-E</code> for ERE and GNU sed uses <code>-r</code>. <code>-E</code> is an alias for <code>-r</code> in GNU sed (added in 4.2, not documented until 4.3). Newer versions of FreeBSD and NetBSD sed support both <code>-E</code> and <code>-r</code>. OpenBSD sed only supports <code>-E</code>.</p>
</blockquote>
<blockquote>
<p><code>-i &#39;&#39;</code> works with OS X’s sed but not GNU sed. <code>-i</code> works with GNU sed, recent versions of NetBSD, OpenBSD sed, but not OS X’s sed. <code>-i -e</code> works with both but in the case of FreeBSD sed makes a backup of the original file with <code>-e</code> appended to the file name (and you need to pass no more than one expression to sed).”</p>
</blockquote>
<h2 id="How-to-Fix"><a href="#How-to-Fix" class="headerlink" title="How to Fix:"></a>How to Fix:</h2><p>The way I made my command running properly on MacOS is: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;&apos; -e &apos;/&lt;!-- BlaBlaBla --&gt;/ r ./&lt;file1_name.xml&gt;&apos; ./&lt;file2_name.xml&gt;</span><br></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ol>
<li><a href="https://confluence.qps.nl/fledermaus/questions-answers/other/differences-in-end-of-line-characters-mac-windows-and-linux" target="_blank" rel="noopener">Differences in end of line characters on Mac, Windows and Linux</a></li>
<li><a href="https://unix.stackexchange.com/questions/13711/differences-between-sed-on-mac-osx-and-other-standard-sed" target="_blank" rel="noopener">Differences between sed on Mac OSX and other “standard” sed?</a></li>
<li>StackOverflow:</li>
</ol>
<ul>
<li><a href="https://stackoverflow.com/questions/19456518/invalid-command-code-despite-escaping-periods-using-sed" target="_blank" rel="noopener">https://stackoverflow.com/questions/19456518/invalid-command-code-despite-escaping-periods-using-sed</a></li>
<li><a href="https://stackoverflow.com/questions/7573368/in-place-edits-with-sed-on-os-x" target="_blank" rel="noopener">https://stackoverflow.com/questions/7573368/in-place-edits-with-sed-on-os-x</a></li>
<li><a href="https://stackoverflow.com/questions/4247068/sed-command-with-i-option-failing-on-mac-but-works-on-linux" target="_blank" rel="noopener">https://stackoverflow.com/questions/4247068/sed-command-with-i-option-failing-on-mac-but-works-on-linux</a> </li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ronnywang99.github.io/2019/01/22/GCP-API-management-thru-ESP-service/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhe Wang">
      <meta itemprop="description" content="不积跬步，无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ronny's Notebook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/22/GCP-API-management-thru-ESP-service/" class="post-title-link" itemprop="url">GCP API management thru ESP service</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-22 13:53:05" itemprop="dateCreated datePublished" datetime="2019-01-22T13:53:05-05:00">2019-01-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-08 15:04:32" itemprop="dateModified" datetime="2019-02-08T15:04:32-05:00">2019-02-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Project-Notes/" itemprop="url" rel="index"><span itemprop="name">Project Notes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Description"><a href="#Description" class="headerlink" title="Description:"></a>Description:</h2><p>We were deploying one updates to enable ESP service for protecting our application’s API endpoint.<br>The updates includes configurations changes in drone.yaml and kube.yaml files.</p>
<p>Issue was observed after release in GCP console, that the corresponding ESP workloads are not spinning up properly.</p>
<h3 id="Errors-from-Log"><a href="#Errors-from-Log" class="headerlink" title="Errors from Log:"></a>Errors from Log:</h3><pre><code>INFO:Fetching the service configuration from the service management service  
INFO:Fetching the service config ID from the rollouts service
INFO:Fetching an access token from the metadata service

ERROR:Fetching rollouts failed (status code 403, reason Forbidden, url https://servicemanagement.googleapis.com/v1/services/&lt;app_name&gt;.endpoints.&lt;project_name&gt;.cloud.goog/rollouts?filter=status=SUCCESS)
</code></pre><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis:"></a>Analysis:</h2><p>The new configured ESP services is up, but as per the status code 403, it seems there is access permission not granted properly. </p>
<p>Based on searching around using “<em>Fetching the service config ID from the rollouts service</em>“, it is found that the Compute Engine default service account doesn’t have permission to access the new ESP workloads. </p>
<h2 id="How-to-fix"><a href="#How-to-fix" class="headerlink" title="How to fix:"></a>How to fix:</h2><p>In <strong>GCP console -&gt; IAM &amp; admin panel</strong>, find “Compute Engine default service account” in the list, and add “<strong>Service Controller</strong>“ to its roles list.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ol>
<li><a href="https://cloud.google.com/iam/docs/understanding-service-accounts" target="_blank" rel="noopener">Understanding Service Accounts</a></li>
<li><a href="https://cloud.google.com/service-infrastructure/docs/glossary#managed" target="_blank" rel="noopener">Managed service</a></li>
<li><a href="https://cloud.google.com/iam/docs/understanding-roles#service-management-roles" target="_blank" rel="noopener">GCP Service Management Roles</a></li>
<li><a href="https://cloud.google.com/service-infrastructure/docs/service-management/access-control" target="_blank" rel="noopener">GCP Service Management API Access Control</a></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ronnywang99.github.io/2019/01/18/Start-noting-down-thru-Hexo/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhe Wang">
      <meta itemprop="description" content="不积跬步，无以至千里">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ronny's Notebook">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/18/Start-noting-down-thru-Hexo/" class="post-title-link" itemprop="url">Start noting down thru Hexo</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-18 15:31:10" itemprop="dateCreated datePublished" datetime="2019-01-18T15:31:10-05:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-02-14 11:40:18" itemprop="dateModified" datetime="2019-02-14T11:40:18-05:00">2019-02-14</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This is my first blog posted thru Hexo.<br>I will write down something (ideas, working notes, thoughts, experiments, etc) and publish/track here. </p>
<p>The blog was built using Hexo with theme called Next (Thanks <a href="https://notes.iissnan.com/2015/something-about-next/" target="_blank" rel="noopener">IIssNan</a> creating this beautiful blog them)</p>
<h2 id="Starting-from-Hexo"><a href="#Starting-from-Hexo" class="headerlink" title="Starting from Hexo"></a>Starting from Hexo</h2><p><a href="https://hexo.io/docs/" target="_blank" rel="noopener">Hexo Docs</a></p>
<h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
<h2 id="Using-Next-as-the-blog-theme"><a href="#Using-Next-as-the-blog-theme" class="headerlink" title="Using Next as the blog theme"></a>Using Next as the blog theme</h2><p>More info: <a href="https://github.com/iissnan/theme-next-docs" target="_blank" rel="noopener">Next Theme Docs</a><br>And <a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">Next Official Site</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhe Wang</p>
              <p class="site-description motion-element" itemprop="description">不积跬步，无以至千里</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://github.com/ronnywang99" title="GitHub &rarr; https://github.com/ronnywang99" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://www.facebook.com/ronny.wang.94" title="FB Page &rarr; https://www.facebook.com/ronny.wang.94" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://instagram.com/ronnywang9" title="Instagram &rarr; https://instagram.com/ronnywang9" rel="noopener" target="_blank"><i class="fa fa-fw fa-instagram"></i></a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhe Wang</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>



  

  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
